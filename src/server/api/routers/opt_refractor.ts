// ============================================
// 1. é…ç½®å’Œé¡å‹å®šç¾©
// ============================================

import { convert } from "html-to-text";
import { OpenAI } from "openai";
import { z } from "zod";
import { env } from "~/env";
import { createTRPCRouter, publicProcedure } from "~/server/api/trpc";

// OpenAI å®¢æˆ¶ç«¯åˆå§‹åŒ–
const openai = new OpenAI({
	apiKey: env.OPENAI_API_KEY,
});

// è¼¸å…¥åƒæ•¸çš„ Zod schema
const analyzeContentSchema = z.object({
	page: z.string(),
	bestQuery: z.string().nullable(),
	bestQueryClicks: z.number().nullable(),
	bestQueryPosition: z.number().nullable(),
	// å‰æœŸæ•¸æ“š
	prevBestQuery: z.string().nullable(),
	prevBestPosition: z.number().nullable(),
	prevBestClicks: z.number().nullable(),
	// æ’åé—œéµè© (4-10å)
	rank4: z.string().nullable(),
	rank5: z.string().nullable(),
	rank6: z.string().nullable(),
	rank7: z.string().nullable(),
	rank8: z.string().nullable(),
	rank9: z.string().nullable(),
	rank10: z.string().nullable(),
});

// åœ°å€èªè¨€è¨­å®šé¡å‹
interface LocaleSettings {
	language: string;
	style: string;
	examples: string;
	tone: string;
}

// ============================================
// 2. è¼”åŠ©å‡½æ•¸
// ============================================

/**
 * å¾ URL ä¸­æå–åœ°å€ä»£ç¢¼
 */
function extractRegionFromUrl(url: string): string {
	if (url.includes("holidaysmart.io")) {
		return url.match(/\/(hk|tw|sg)\//)?.[1] || "hk";
	}
	return "hk";
}

/**
 * ç²å–åœ°å€èªè¨€è¨­å®š
 */
function getLocaleSettings(region: string): LocaleSettings {
	const localeSettings = {
		hk: {
			language: "ç¹é«”ä¸­æ–‡ï¼ˆé¦™æ¸¯ï¼‰",
			style: "æ¸¯å¼ç”¨è©",
			examples: "ä¿‚ã€åšŸã€å””ã€å’ã€å•±ã€èˆ–é ­",
			tone: "è¦ªåˆ‡ã€åœ°é“ã€ç”Ÿæ´»åŒ–",
		},
		tw: {
			language: "ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ï¼‰",
			style: "å°å¼ç”¨è©",
			examples: "çš„ã€ä¾†ã€ä¸ã€é€™æ¨£ã€å°ã€åº—å®¶",
			tone: "æº«é¦¨ã€åœ¨åœ°ã€è²¼å¿ƒ",
		},
		cn: {
			language: "ç°¡é«”ä¸­æ–‡ï¼ˆä¸­åœ‹å¤§é™¸ï¼‰",
			style: "å¤§é™¸ç”¨è©",
			examples: "çš„ã€æ¥ã€ä¸ã€è¿™æ ·ã€å¯¹ã€å•†å®¶",
			tone: "å°ˆæ¥­ã€ç›´æ¥ã€å¯¦ç”¨",
		},
		sg: {
			language: "ç¹é«”ä¸­æ–‡ï¼ˆæ–°åŠ å¡ï¼‰",
			style: "æ˜Ÿå¼ç”¨è©",
			examples: "çš„ã€ä¾†ã€ä¸ã€é€™æ¨£ã€å°ã€åº—èˆ–",
			tone: "å¤šå…ƒã€ç¾ä»£ã€ç°¡æ½”",
		},
		default: {
			language: "ç¹é«”ä¸­æ–‡",
			style: "æ¨™æº–ç”¨è©",
			examples: "çš„ã€ä¾†ã€ä¸ã€é€™æ¨£ã€å°ã€åº—èˆ–",
			tone: "ä¸­æ€§ã€æ¨™æº–ã€æ¸…æ™°",
		},
	};

	return (
		localeSettings[region as keyof typeof localeSettings] ||
		localeSettings.default
	);
}

/**
 * å¾ HTML ä¸­æå– meta è³‡è¨Š
 */
function extractMetaInfo(html: string) {
	const titleMatch = html.match(/<title>(.*?)<\/title>/i);
	const metaDescMatch = html.match(
		/<meta[^>]*name="description"[^>]*content="([^"]*)"[^>]*>/i,
	);
	const ogTitleMatch = html.match(
		/<meta[^>]*property="og:title"[^>]*content="([^"]*)"[^>]*>/i,
	);
	const ogDescMatch = html.match(
		/<meta[^>]*property="og:description"[^>]*content="([^"]*)"[^>]*>/i,
	);

	return {
		pageTitle: titleMatch?.[1] || "",
		metaDescription: metaDescMatch?.[1] || "",
		ogTitle: ogTitleMatch?.[1] || "",
		ogDescription: ogDescMatch?.[1] || "",
	};
}

/**
 * å¾ HTML ä¸­æå–åœ–ç‰‡ä½ç½®è³‡è¨Š
 */
function extractImagePositions(html: string): string {
	const imgRegex = /<img[^>]*>/gi;
	const images = [];
	let match;
	let count = 0;

	while ((match = imgRegex.exec(html)) && count < 10) {
		const altMatch = match[0].match(/alt=["']([^"']*?)["']/i);
		const altText = altMatch?.[1] || "";

		const beforeImg = html.substring(0, match.index).replace(/<[^>]*>/g, "");
		const cleanText = beforeImg.replace(/\s+/g, " ").trim();
		const position = cleanText.length;

		images.push(`[åœ–${count + 1}:"${altText}", ä½ç½®:${position}å­—]`);
		count++;
	}

	return images.length > 0 ? "\n\nåœ–ç‰‡è³‡è¨Šï¼š" + images.join(", ") : "";
}

/**
 * å¾ HTML ä¸­æå–æ–‡ç« å…§å®¹
 */
function extractArticleContent(html: string): {
	text: string;
	imageInfo: string;
} {
	// å˜—è©¦æ‰¾åˆ°ä¸»è¦æ–‡ç« å…§å®¹
	const articleMatch = html.match(
		/<article[^>]*class="[^"]*pl-main-article[^"]*"[^>]*>([\s\S]*?)<\/article>/i,
	);

	let textContent = "";
	let imageInfo = "";

	if (articleMatch?.[1]) {
		textContent = convert(articleMatch[1], {
			wordwrap: false,
			selectors: [
				{ selector: "a", options: { ignoreHref: true } },
				{ selector: "img", format: "skip" },
			],
		});
		imageInfo = extractImagePositions(articleMatch[1]);
	} else {
		// å‚™ç”¨æ–¹æ¡ˆï¼šå˜—è©¦å…¶ä»–é¸æ“‡å™¨
		const mainContentMatch = html.match(
			/<div[^>]*class="[^"]*pl-main-article[^"]*"[^>]*>([\s\S]*?)<\/div>/i,
		);

		if (mainContentMatch?.[1]) {
			textContent = convert(mainContentMatch[1], {
				wordwrap: false,
				selectors: [
					{ selector: "a", options: { ignoreHref: true } },
					{ selector: "img", format: "skip" },
				],
			});
			imageInfo = extractImagePositions(mainContentMatch[1]);
		} else {
			// æœ€å¾Œæ‰‹æ®µï¼šæå–åŸºæœ¬å…§å®¹
			const titleMatch = html.match(/<title>(.*?)<\/title>/i);
			const title = titleMatch?.[1] || "";
			textContent =
				title +
				" " +
				convert(html, {
					wordwrap: false,
					selectors: [
						{ selector: "a", options: { ignoreHref: true } },
						{ selector: "img", format: "skip" },
					],
				}).substring(0, 4000);
			imageInfo = extractImagePositions(html);
		}
	}

	// æ¸…ç†ä¸éœ€è¦çš„å…§å®¹
	textContent = cleanupContent(textContent);

	return { text: textContent, imageInfo };
}

/**
 * æ¸…ç†æ–‡æœ¬å…§å®¹
 */
function cleanupContent(text: string): string {
	return text
		.replace(/data-key="[^"]*"/g, "")
		.replace(/ad-id-[a-z0-9]+/g, "")
		.replace(/data-v-[a-f0-9]+/g, "")
		.replace(/loading\.png/g, "")
		.replace(/presslogic-hk-hd\/static\/images/g, "")
		.replace(/\/hk\/category\/[a-zA-Z-]+/g, "")
		.replace(/\/hk\/author\/[a-zA-Z-]+/g, "")
		.replace(/By [A-Za-z\s]+ on \d+ [A-Za-z]+ \d+/g, "")
		.replace(/Digital Editor/g, "")
		.replace(/é¦™æ¸¯å¥½å»è™•|ç”Ÿæ´»ç†±è©±|è³¼ç‰©è‘—æ•¸|ç¾é£Ÿæ¨ä»‹|æ—…éŠæ”»ç•¥/g, "")
		.replace(/\s+/g, " ")
		.trim()
		.substring(0, 8000);
}

/**
 * ç§»é™¤å­—ä¸²ä¸­çš„ç©ºæ ¼ï¼ˆç”¨æ–¼é‡è¤‡æª¢æ¸¬ï¼‰
 */
function removeSpaces(str: string): string {
	return str.replace(/\s+/g, "");
}

// ============================================
// 3. é—œéµè©è™•ç†
// ============================================

interface ProcessedKeyword {
	keyword: string;
	rank: number;
	clicks?: number;
	normalized: string;
}

interface KeywordAnalysis {
	keywordsList: string[];
	allKeywords: string[];
	attributeWords: Set<string>;
	uniqueKeywords: string[];
}

/**
 * è™•ç†æ’åé—œéµè©æ•¸æ“š
 */
function processRankKeywords(
	rankData: { [key: string]: string | null },
	bestQuery: string | null,
): KeywordAnalysis {
	const keywordsList: string[] = [];
	const allKeywords: string[] = [];
	const attributeWords = new Set<string>();
	const seenNormalizedKeywords = new Set<string>();

	const bestQueryNormalized = removeSpaces(bestQuery || "");
	const bestQueryForAttributes = (bestQuery || "").replace(/\s+/g, "");
	const bestQueryChars = bestQueryForAttributes.split("");

	// è™•ç†æ¯å€‹æ’åçš„é—œéµè©
	const processRank = (data: string | null, rank: number) => {
		if (!data) return;

		const keywords = data.split(",").map((k) => k.trim());

		keywords.forEach((keyword) => {
			if (!keyword) return;

			// æå–é—œéµè©å’Œé»æ“Šæ•¸
			const match = keyword.match(/^(.+?)\((\d+)\)$/);
			const kw = match?.[1] || keyword;
			const clicks = match?.[2] || "";

			const kwNormalized = removeSpaces(kw);

			// è·³éé‡è¤‡çš„é—œéµè©
			if (
				kwNormalized === bestQueryNormalized ||
				seenNormalizedKeywords.has(kwNormalized)
			) {
				return;
			}

			seenNormalizedKeywords.add(kwNormalized);

			// æå–å±¬æ€§è©
			if (bestQuery) {
				const kwNormalizedForAttr = kw.replace(/\s+/g, "");
				let remainingChars = kwNormalizedForAttr;

				bestQueryChars.forEach((char) => {
					remainingChars = remainingChars.replace(char, "");
				});

				if (remainingChars.length > 1) {
					attributeWords.add(remainingChars);
				}
			}

			// æ·»åŠ åˆ°åˆ—è¡¨
			if (clicks) {
				keywordsList.push(`- ${kw} (rank: ${rank}, clicks: ${clicks})`);
				allKeywords.push(`${kw}(${clicks})`);
			} else {
				keywordsList.push(`- ${kw} (rank: ${rank})`);
				allKeywords.push(kw);
			}
		});
	};

	// è™•ç† rank 4-10 çš„æ•¸æ“š
	for (let rank = 4; rank <= 10; rank++) {
		processRank(rankData[`rank${rank}`] ?? null, rank);
	}

	// å»é‡ä¸¦ç²å–å”¯ä¸€é—œéµè©
	const normalizedKeywordMap = new Map<string, string>();
	allKeywords.forEach((kw) => {
		const normalized = kw.replace(/\s+/g, "");
		if (!normalizedKeywordMap.has(normalized)) {
			normalizedKeywordMap.set(normalized, kw);
		}
	});

	const uniqueKeywords = Array.from(normalizedKeywordMap.values()).filter(
		Boolean,
	);

	return {
		keywordsList,
		allKeywords,
		attributeWords,
		uniqueKeywords,
	};
}

// ============================================
// 4. AI æç¤ºè©ç”Ÿæˆ
// ============================================

/**
 * ç”Ÿæˆ SEO åˆ†æçš„æç¤ºè©
 */
function generateSEOPrompt(
	input: z.infer<typeof analyzeContentSchema>,
	localeSettings: LocaleSettings,
	metaInfo: ReturnType<typeof extractMetaInfo>,
	textContent: string,
	keywordsList: string[],
): string {
	// é€™è£¡åŒ…å«å®Œæ•´çš„æç¤ºè©æ¨¡æ¿
	// ç‚ºäº†ç°¡æ½”ï¼Œæˆ‘åªå±•ç¤ºçµæ§‹
	return `
# Role and Objective

è©•ä¼° SEO èªæ„åŠ«æŒæ½›åŠ›ï¼Œåˆ©ç”¨ Rank 4-10 é—œéµå­—æ•¸æ“šï¼Œåˆ¶å®šèªæ„ç­‰åƒ¹ç­–ç•¥åƒè€ƒæœ€ä½³è¡¨ç¾æŸ¥è©¢
ä½ æ˜¯ SEO èªç¾©åŠ«æŒå°ˆå®¶ï¼Œä¸æ˜¯é—œéµè©å¡«å……æ©Ÿå™¨
ğŸ¯ æ ¸å¿ƒç›®æ¨™ï¼šè­˜åˆ¥æœ‰é¡¯è‘—æ€§çš„ä½æ‘©æ“¦è©ï¼Œå»ºç«‹èˆ‡ Best Query çš„èªç¾©ç­‰åƒ¹

âš ï¸ **é—œéµæ€ç¶­è½‰è®Š**ï¼š
- ä½ è¦æ‰¾çš„ä¸æ˜¯ã€Œæ‰€æœ‰æ©Ÿæœƒã€ï¼Œè€Œæ˜¯ã€Œç¼ºäº†å°±ç„¡æ³•æˆåŠŸåŠ«æŒçš„å¿…å‚™è¦ç´ ã€
- æƒ³åƒä½ åªèƒ½æ”¹ 10-20% çš„å…§å®¹ï¼Œé€™äº›æ”¹å‹•å¿…é ˆæ˜¯æ±ºå®šæ€§çš„
- ä¸æ˜¯æ’’ç¶²ï¼Œæ˜¯ç²¾æº–ç‹™æ“Š
- **åŠ«æŒ = è®“ A æˆç‚º B çš„æœ€ä½³ç­”æ¡ˆï¼Œä¸æ˜¯è®“ A å’Œ B æ”¾åœ¨ä¸€èµ·**

# Instructions

é–‹å§‹æ™‚åˆ—å‡º 3-7 é …ç°¡è¦æ¦‚å¿µæ€§æª¢æŸ¥æ¸…å–®ï¼Œè¦åŠƒä½ å°‡æ¡å–çš„æ­¥é©Ÿ
æ ¹æ“šæä¾›çš„æ•¸æ“šï¼Œåˆ†è¾¨å‡ºå“ªäº›é—œéµå­—å…·å‚™èªæ„åŠ«æŒæ©Ÿæœƒ
æ ¹æ“š Best Queryã€æ­·å² Best Queryã€æ˜¯å¦æœ‰è®ŠåŒ–ï¼Œä»¥åŠé—œéµå­—å°¾å‹ï¼ˆçŸ­å°¾/é•·å°¾ï¼‰ï¼Œæ“¬å®šèªæ„ç­‰åƒ¹ç­–ç•¥
åœ¨è³‡æ–™ç¼ºå¤±ï¼ˆå¦‚ Best Query =ã€ŒæœªçŸ¥ã€æˆ–ã€Œç„¡æ•¸æ“šã€ï¼‰æ™‚ï¼Œè«‹ä»¥ 'N/A' æ¨™ç¤ºä¸¦ç¹¼çºŒï¼Œä¸éœ€å ±éŒ¯
è«‹åš´æ ¼éµå®ˆæŒ‡å®šè¼¸å‡ºæ ¼å¼ï¼Œæ‰€æœ‰æ¨™é¡Œéœ€ä¾æ­£ç¢º Markdown éšå±¤ï¼ˆ##ã€###ï¼‰æ¨™ç¤ºã€‚é€™å°å¾ŒçºŒè‡ªå‹•è™•ç†è‡³é—œé‡è¦
ä½ è¦åŸºæ–¼æ•¸æ“šåˆ†æï¼Œä¸æ˜¯æ†‘ç©ºæƒ³åƒ
å¿…é ˆä½¿ç”¨æŒ‡å®šçš„åœ°å€èªè¨€é¢¨æ ¼ï¼Œæ¨™é¡Œå»ºè­°è¦ç¬¦åˆç•¶åœ°è¡¨é”ç¿’æ…£

**å¿…å‚™è¦ç´ è­˜åˆ¥ä¸‰å•**ï¼ˆæ¯å€‹å»ºè­°éƒ½è¦é€šéé€™ä¸‰é—œï¼‰ï¼š
1. é€™å€‹è©æ˜¯å¦ä»£è¡¨ Best Query çš„ã€Œæ ¸å¿ƒç¼ºå£ã€ï¼Ÿ
2. è£œä¸Šé€™å€‹è©ï¼Œæ˜¯å¦èƒ½ç«‹å³é™ä½ç”¨æˆ¶æ±ºç­–æ‘©æ“¦ï¼Ÿ
3. ä¸åŠ é€™å€‹è©ï¼ŒåŠ«æŒæ˜¯å¦æœƒå¤±æ•—ï¼Ÿ

ä¸‰å€‹éƒ½æ˜¯ã€Œæ˜¯ã€â†’ å¿…å‚™è¦ç´  / ä»»ä½•ä¸€å€‹ã€Œå¦ã€â†’ ä¸åˆ—å…¥å»ºè­°

**ğŸš¨ èªæ„ç­‰åƒ¹é©—è­‰ï¼ˆæ–°å¢ï¼‰**ï¼š
å•è‡ªå·±ï¼šç”¨æˆ¶æœã€ŒBest Queryã€ï¼Œçµ¦ä»–ã€Œå»ºè­°è©ã€çš„å…§å®¹ï¼Œä»–æœƒæ»¿æ„å—ï¼Ÿ
- æœƒæ»¿æ„ â†’ å¯èƒ½ç­‰åƒ¹
- ä¸æœƒæ»¿æ„ â†’ åªæ˜¯ç›¸é—œï¼Œä¸èƒ½åŠ«æŒ

# Sub-categories

æ¯å€‹é—œéµå­—éœ€åŒ…å« keywordã€rankã€clicksã€åˆ†é¡ï¼ˆå…·é«”/å»£æ³›ï¼‰ã€æ©Ÿæœƒåˆ†æ
èªæ„ç­‰åƒ¹ç­–ç•¥éœ€åˆ†æ best_queryã€prev_best_queryã€æ˜¯å¦æœ‰è®ŠåŒ–ï¼Œä»¥åŠé—œéµå­—å°¾å‹ï¼Œçµ¦å‡ºå…·é«”ç­–ç•¥å»ºè­°
summary è«‹ç°¡æ˜é™³è¿°èªæ„åŠ«æŒæ©ŸæœƒåŠç­–ç•¥æ ¸å¿ƒ

## è©å½™é¡å‹å®šç¾©èˆ‡åŠ«æŒåƒ¹å€¼è©•ä¼°ï¼š

### **å‚ç›´ç”¨è©**ï¼ˆåŒé ˜åŸŸå»¶ä¼¸ï¼‰
- å®šç¾©ï¼šèˆ‡åŸæ–‡ä¸»é¡Œç›´æ¥ç›¸é—œçš„ç´°åŒ–è©å½™
- ä¾‹ï¼šèˆ¹ç¥¨æ–‡ç« çš„ã€Œèˆ¹æœŸã€ã€Œèˆ¹ç­ã€ã€Œè³¼ç¥¨æ–¹å¼ã€
- **åŠ«æŒåƒ¹å€¼åˆ¤æ–·**ï¼š
  - å–®ä¸€å‚ç›´è© = å°è£œå……ï¼ˆé€šå¸¸ä¸æ˜¯å¿…å‚™ï¼‰
  - å‚ç›´è©ç¾¤å½¢æˆå®Œæ•´è«–è¿° = å¯èƒ½æ˜¯å¿…å‚™è¦ç´ 
  - é—œéµå•ï¼šé€™äº›è©èƒ½å¦å½¢æˆã€Œæ±ºå®šæ€§å„ªå‹¢ã€ï¼Ÿ
  
### **å¯è©³è¿°è©**ï¼ˆéœ€å±•é–‹èªªæ˜ï¼‰
- å®šç¾©ï¼šéœ€è¦ç¨ç«‹ç¯‡å¹…è©³ç´°èªªæ˜çš„æ¦‚å¿µè©
- ä¾‹ï¼šèˆ¹ç¥¨æ–‡ç« é‡åˆ°ã€Œäº¤é€šæ”»ç•¥ã€ã€Œæ—…éŠæŒ‡å—ã€
- **åŠ«æŒåƒ¹å€¼åˆ¤æ–·**ï¼š
  - å¦‚æœæ˜¯ Best Query çš„ã€ŒçœŸå¯¦æ„åœ–ã€â†’ å¿…å‚™è¦ç´ 
  - å¦‚æœåªæ˜¯ç›¸é—œä½†éæ ¸å¿ƒ â†’ å¿½ç•¥
  - é—œéµå•ï¼šç”¨æˆ¶æœ Best Query æ˜¯å¦å°±æ˜¯è¦æ‰¾é€™å€‹ï¼Ÿ
  
### **é è·é›¢è©**ï¼ˆå¹³è¡Œæ¦‚å¿µï¼‰
- å®šç¾©ï¼šèˆ‡åŸæ–‡ä¸»é¡Œç›¸è·è¼ƒé çš„å¹³è¡Œæ¦‚å¿µ
- ä¾‹ï¼šèˆ¹ç¥¨æ–‡ç« é‡åˆ°ã€Œä½å®¿æ¨è–¦ã€ã€Œç¾é£Ÿæ”»ç•¥ã€
- **åŠ«æŒåƒ¹å€¼åˆ¤æ–·**ï¼š
  - é€šå¸¸ä¸æ˜¯å¿…å‚™ï¼ˆé™¤éæ•¸æ“šé¡¯ç¤ºå¼·é—œè¯ï¼‰
  - é—œéµå•ï¼šé€™çœŸçš„æ˜¯åŒä¸€æ‰¹ç”¨æˆ¶è¦çš„å—ï¼Ÿ

## èªæ„é—œä¿‚åˆ†é¡ï¼ˆæ–°å¢ - é—œéµå€åˆ¥ï¼‰

### **ç­‰åƒ¹é—œä¿‚** âœ… å¯ä»¥åŠ«æŒ
- A å¯ä»¥ä»£è¡¨ B çš„æ ¸å¿ƒæ„åœ–
- ç”¨æˆ¶æœ B çœ‹åˆ° A æœƒè¦ºå¾—ã€Œå°ï¼Œé€™å°±æ˜¯æˆ‘è¦çš„ã€
- ä¾‹ï¼š
  - ã€Œæœ€å¼·è§’è‰²ã€ç­‰åƒ¹ã€Œæ’åã€ï¼ˆæœ€å¼·å°±æ˜¯ç¬¬ä¸€åï¼‰
  - ã€Œèˆ¹ç¥¨ã€ç­‰åƒ¹ã€Œäº¤é€šã€ï¼ˆç•¶åœ°ä¸»è¦äº¤é€šå°±æ˜¯èˆ¹ï¼‰
  - ã€ŒTableauæ•™å­¸ã€ç­‰åƒ¹ã€Œæ•¸æ“šåˆ†æã€ï¼ˆTableauæ˜¯ä¸»æµå·¥å…·ï¼‰

### **å¾å±¬é—œä¿‚** âœ… å¯ä»¥åŠ«æŒ
- A æ˜¯ B çš„å…·é«”åŒ–ç‰ˆæœ¬
- ä¾‹ï¼š
  - ã€Œè§’è‰²å¼·åº¦æ’è¡Œã€å¾å±¬æ–¼ã€Œæ’åã€
  - ã€Œæ¢…å·èˆ¹ç¥¨ã€å¾å±¬æ–¼ã€Œæ¢…å·äº¤é€šã€

### **ç›¸é—œé—œä¿‚** âŒ ä¸èƒ½åŠ«æŒ
- A å’Œ B åªæ˜¯åŒä¸»é¡Œçš„ä¸åŒé¢å‘
- ç”¨æˆ¶æœ B çœ‹åˆ° A æœƒè¦ºå¾—ã€Œé€™ä¸æ˜¯æˆ‘è¦çš„ã€
- ä¾‹ï¼š
  - ã€Œåœ–é‘‘ã€ç›¸é—œä½†ä¸ç­‰åƒ¹ã€Œæ’åã€ï¼ˆè³‡æ–™åº« â‰  è©•æ¯”ï¼‰
  - ã€Œå€‹æ€§æŸ¥è©¢ã€ç›¸é—œä½†ä¸ç­‰åƒ¹ã€Œæ’åã€ï¼ˆå·¥å…· â‰  çµæœï¼‰
  - ã€Œæ”»ç•¥ã€ç›¸é—œä½†ä¸ç­‰åƒ¹ã€Œæ’åã€ï¼ˆæ–¹æ³• â‰  è©•åƒ¹ï¼‰

### **ç„¡é—œé—œä¿‚** âŒ çµ•å°ä¸èƒ½åŠ«æŒ
- ä¸åŒä¸»é¡Œï¼Œç”¨æˆ¶æ„åœ–å®Œå…¨ä¸åŒ

# Context
- æ–‡ç«  URLï¼š${input.page}
- åœ°å€èªè¨€ï¼š${localeSettings.language} - ${localeSettings.style}
- èªè¨€ç‰¹è‰²ç¯„ä¾‹ï¼š${localeSettings.examples}
- èªèª¿è¦æ±‚ï¼š${localeSettings.tone}
- ç¾æœ‰æ¨™é¡Œï¼š${metaInfo.pageTitle}
- Meta æè¿°ï¼š${metaInfo.metaDescription}
- OG æ¨™é¡Œï¼š${metaInfo.ogTitle}
- Best Queryï¼ˆæ’å1-3ï¼‰ï¼šã€Œ${input.bestQuery || "N/A"}ã€ - ${
		input.bestQueryClicks || 0
	} æ¬¡é»æ“Š - å¹³å‡æ’å ${input.bestQueryPosition || "N/A"}
- å‰æœŸ Best Queryï¼š${
		input.prevBestQuery
			? `ã€Œ${input.prevBestQuery}ã€ - ${
					input.prevBestClicks || 0
				} æ¬¡é»æ“Š - å¹³å‡æ’å ${input.prevBestPosition || "N/A"}`
			: "N/A"
	}
- æ˜¯å¦æœ‰è®ŠåŒ–ï¼š${input.prevBestQuery && input.bestQuery !== input.prevBestQuery}
é—œéµå­—åˆ—è¡¨ï¼ˆRank 4-10ï¼‰:
${keywordsList.join("\n")}
## æ•¸æ“šæ ¼å¼èªªæ˜
- æ¯å€‹é—œéµå­—æ ¼å¼ï¼škeyword (rank: X, clicks: Y)
- rankï¼šæ–¼ Google çš„å¹³å‡æ’å
- clicksï¼šéå»14å¤©ç¸½é»æ“Šæ•¸
- å…·é«”ï¼šä½é»æ“Šè©å¤šç‚ºå…·é«”ã€ç”¨æˆ¶éœ€æ±‚ä½†ä¸ç†Ÿæ‚‰ä¹‹è©
- å»£æ³›ï¼šé«˜é»æ“Šè©å¤šç‚ºå»£æ³›ã€ç”¨æˆ¶ç†Ÿæ‚‰çš„å¸¸ç”¨è©
- Best Query è®ŠåŒ–ä»£è¡¨æ¶æ”»å¤±æ•—/æˆåŠŸï¼›éœ€æª¢æŸ¥æ–°ç¾æ³é—œéµå­—è¦æ¨¡ï¼ˆçŸ­å°¾/é•·å°¾ï¼‰ã€‚
- æ–‡ç« æ“·å–ç‰‡æ®µï¼š
${textContent.substring(0, 4000)}

 Reasoning Steps

## TO DOï¼ˆåŸ·è¡Œæ­¥é©Ÿï¼‰

1. åˆ†æ Best Query çš„æ ¸å¿ƒæ¦‚å¿µå’Œç”¨æˆ¶éœ€æ±‚
2. **èªæ„é—œä¿‚åˆ¤æ–·**ï¼ˆæ–°å¢é—œéµæ­¥é©Ÿï¼‰ï¼š
   å°æ¯å€‹ Rank 4-10 çš„è©é€²è¡Œé—œä¿‚åˆ†é¡ï¼š
   - ç­‰åƒ¹é—œä¿‚ï¼šå¯äº’ç›¸ä»£è¡¨ â†’ âœ… å¯åŠ«æŒ
   - å¾å±¬é—œä¿‚ï¼šA æ˜¯ B çš„å…·é«”ç‰ˆæœ¬ â†’ âœ… å¯åŠ«æŒ
   - ç›¸é—œé—œä¿‚ï¼šåŒä¸»é¡Œä¸åŒé¢å‘ â†’ âŒ ä¸èƒ½åŠ«æŒ
   - ç„¡é—œé—œä¿‚ï¼šä¸åŒä¸»é¡Œ â†’ âŒ çµ•å°ä¸èƒ½
   
   **æƒ…å¢ƒæ¸¬è©¦**ï¼š
   ç”¨æˆ¶æœã€Œ[Best Query]ã€çœ‹åˆ°ã€Œ[è©•ä¼°è©]ã€
   - æœƒé»æ“Šå—ï¼Ÿï¼ˆå¸å¼•åŠ›ï¼‰
   - é»é€²å»æœƒæ»¿æ„å—ï¼Ÿï¼ˆæ»¿è¶³åº¦ï¼‰
   - è¦ºå¾—å›ç­”äº†å•é¡Œå—ï¼Ÿï¼ˆæ„åœ–åŒ¹é…ï¼‰
   
   ä¸‰å€‹éƒ½æ˜¯ã€Œæ˜¯ã€æ‰èƒ½åŠ«æŒ

3. **ç¼ºå£åˆ†æ**ï¼šBest Query ç”¨æˆ¶çœŸæ­£è¦ä»€éº¼ï¼Ÿç¾æœ‰æ–‡ç« ç¼ºä»€éº¼é—œéµ pieceï¼Ÿ
4. **å¿…å‚™è¦ç´ è­˜åˆ¥**ï¼šåªå¾ã€Œç­‰åƒ¹ã€æˆ–ã€Œå¾å±¬ã€é—œä¿‚çš„è©ä¸­é¸æ“‡

5. **é¡¯è‘—æ€§æ¸¬è©¦**ï¼šé€™å€‹è©èƒ½ä»£è¡¨ Best Query å—ï¼ŸGoogle æœƒèªç‚º [é€™å€‹è©] âŠ‚ [Best Query] å—ï¼Ÿ
6. **çµ„åˆæ•ˆæ‡‰è©•ä¼°**ï¼šä¸è¦å–®ç¨çœ‹è©ï¼Œè¦çœ‹çµ„åˆ
   - å‚ç›´è©A + å‚ç›´è©B = å½¢æˆå®Œæ•´è«–è¿°ï¼Ÿ
   - å¯è©³è¿°è© + ç›¸é—œå‚ç›´è© = é™ä½æ‘©æ“¦ï¼Ÿ
   - æ‰¾å‡ºã€Œ1+1>2ã€çš„çµ„åˆ

7. åˆ¤æ–·å…§å®¹ç­–ç•¥ï¼ˆåŸºæ–¼å¿…å‚™è¦ç´ ç‰¹æ€§ï¼‰ï¼š

**REPOST æ¢ä»¶**ï¼š
- å¿…å‚™è¦ç´ éƒ½æ˜¯å‚ç›´è©
- ä¸æ”¹è®Šæ ¸å¿ƒä¸»é¡Œï¼Œåªæ˜¯è£œå……é—œéµç¼ºå£
- åŠ å…¥å¾Œæ–‡ç« ä¸»é¡Œç„¦é»ä¸æœƒåç§»

**NEW POST æ¢ä»¶**ï¼š
- å¿…å‚™è¦ç´ åŒ…å«å¯è©³è¿°è©æˆ–é è·é›¢è©
- éœ€è¦æ”¹è®Šæ–‡ç« é‡å¿ƒæ‰èƒ½æ¶µè“‹
- åŠ å…¥å¾Œæœƒè®“åŸæ–‡å¤±ç„¦

7. æ ¹æ“šç­–ç•¥åˆ¤æ–·ï¼Œæä¾›å°æ‡‰çš„å…·é«”åŸ·è¡Œæ¸…å–®

## é—œéµè©è©•ä¼°åŸå‰‡ï¼ˆå¼·åŒ–ç‰ˆï¼‰

- **ä¸æ˜¯æ‰€æœ‰ Rank 4-10 çš„è©éƒ½æœ‰åƒ¹å€¼**
- **åªæœ‰ç­‰åƒ¹æˆ–å¾å±¬é—œä¿‚çš„è©æ‰æœ‰åŠ«æŒåƒ¹å€¼**
- æ‰¾å‡ºèˆ‡ Best Query æ‰€éœ€è³‡è¨Šä¸€è‡´ + ä½æ‘©æ“¦çš„è© = åŠ«æŒæ©Ÿæœƒ
- **æ”¹å‹•æ•ˆç›Šæ¯”è©•ä¼°**ï¼š
  - æ”¹å‹•é‡ï¼šéœ€è¦åŠ å¤šå°‘å…§å®¹ï¼Ÿ
  - æ•ˆç›Šï¼šèƒ½å¸¶ä¾†å¤šå°‘åŠ«æŒæ©Ÿæœƒï¼Ÿ
  - å°æ”¹å‹• + å¤§æ•ˆç›Š = å¿…å‚™è¦ç´ 

# Planning and Validation

æ ¸å¿ƒåŸå‰‡

æ±ºç­–æ‘©æ“¦ï¼šç”¨æˆ¶å¾æœå°‹åˆ°è¡Œå‹•çš„è·¯å¾‘é›£åº¦
- ä½æ‘©æ“¦ï¼šæ˜ç¢ºã€ç›´æ¥è¡Œå‹•ï¼ˆå¦‚Tableauæ•™å­¸ã€èˆ¹ç¥¨ã€æˆ²é™¢ï¼‰
- é«˜æ‘©æ“¦ï¼šç± çµ±æ¨¡ç³Šã€éœ€å¤šæ­¥æ±ºç­–ï¼ˆå¦‚æ•¸æ“šåˆ†æã€äº¤é€šã€å¥½å»è™•ï¼‰

è³‡è¨Šéœ€æ±‚ä¸€è‡´æ€§ï¼šè©•ä¼°è©çµ„åŠå…¶æœ€ä½³æŸ¥è©¢çš„ç”¨æˆ¶éœ€æ±‚æ˜¯å¦ä¸€è‡´
- ä¾‹ï¼šæœå°‹ã€Œæ¢…å·èˆ¹æœŸã€å’Œã€Œæ¢…å·äº¤é€šã€åŒå±¬æƒ³è¾¦æ³•æ­èˆ¹
- åä¾‹ï¼šæœå°‹ã€Œå³¶æ°‘åœ–é‘‘ã€å’Œã€Œå³¶æ°‘æˆ¿å±‹ã€æœ‰ä¸åŒéœ€æ±‚

SEO åƒ¹å€¼åˆ¤æ–·ï¼šéœ€åŒæ™‚æ»¿è¶³ã€Œéœ€æ±‚ä¸€è‡´ã€èˆ‡ã€Œä½æ‘©æ“¦ã€æ‰æœ‰åŠ«æŒæ©Ÿæœƒ

æ±ºç­–æ€ç¶­èˆ‡åˆ¤æ–·

ç­–ç•¥è©•ä¼°æ€ç¶­ï¼šåæ˜ ä¸»é¡Œç›¸é—œæ€§åŠèåˆé›£åº¦
åŠ«æŒæˆåŠŸæ¢ä»¶ï¼š
- è©çµ„æº–ç¢ºåæ˜  Best Query çš„å¯¦éš›éœ€æ±‚
- æ‘©æ“¦åº¦ä½æ–¼ Best Queryï¼ˆå…·é«”æ˜ç¢ºï¼Œä¾¿æ–¼æ¡å–è¡Œå‹•ï¼‰
- ç¾æœ‰åˆ‡è§’å¯èåˆè©çµ„å±¬æ€§ï¼Œä¸”æ¨™é¡Œé©åˆå‚ç›´åˆä½µ

æ±ºç­–ç´°å‰‡ï¼š
- REPOSTï¼šç›®æ¨™è©çµ„æ˜¯åŸä¸»é¡Œçš„**å­é›†æˆ–å…·é«”åŒ–**ï¼Œå¯ä½œç‚ºè£œå……è³‡è¨Šå­˜åœ¨
- NEW POSTï¼šç›®æ¨™è©çµ„æ˜¯**å¹³è¡Œåˆ‡è§’**ï¼Œéœ€è¦ç¨ç«‹å®Œæ•´çš„å…§å®¹æ”¯æ’
- é—œéµå•é¡Œï¼šé€™å€‹ç­–ç•¥æ˜¯åœ¨**æ·±åŒ–**åŸä¸»é¡Œï¼Œé‚„æ˜¯**æ©«å‘æ“´å±•**åˆ°æ–°ä¸»é¡Œï¼Ÿ

é‡è¦è©•ä¼°åŸå‰‡

ğŸš¨ ä¸»é¡Œç›¸é—œæ€§åˆ¤æ–·ï¼š
- **å¯èåˆï¼ˆREPOSTï¼‰**ï¼š
  * æ–°å…§å®¹å¼·åŒ–åŸæ–‡çš„æ ¸å¿ƒè«–é»
  * è£œå……å…·é«”ä¾‹å­ã€æ•¸æ“šæˆ–æ“ä½œç´°ç¯€
  * ä¾‹ï¼šã€Šæ¢…å·èˆ¹ç¥¨æ”»ç•¥ã€‹åŠ å…¥ã€Œæœ€æ–°èˆ¹æœŸæ™‚åˆ»è¡¨ã€â†’ ä»æ˜¯èˆ¹ç¥¨æ–‡ç« 
  
- **éœ€ç¨ç«‹ï¼ˆNEW POSTï¼‰**ï¼š
  * æ–°å…§å®¹é–‹å•Ÿä¸åŒçš„è¨è«–è§’åº¦
  * éœ€è¦æ”¹è®Šæ–‡ç« æ¨™é¡Œæ‰èƒ½æ¶µè“‹
  * ä¾‹ï¼šã€Šæ¢…å·èˆ¹ç¥¨æ”»ç•¥ã€‹è¦æ¶µè“‹ã€Œæ¢…å·å·´å£«è·¯ç·šè©³è§£ã€â†’ éœ€è¦æ–°æ–‡ç« 

- **å¿«é€Ÿåˆ¤æ–·æ³•**ï¼š
  å¦‚æœè¦å®Œæ•´èªªæ˜é€™å€‹æ–°ç­–ç•¥ï¼Œæœƒä¸æœƒè®“åŸæ–‡ç« ã€Œå¤±ç„¦ã€ï¼Ÿ
  æœƒå¤±ç„¦ â†’ NEW POST / ä¸æœƒå¤±ç„¦ â†’ REPOST

æ‰€éœ€æ”¹å‹•ï¼š[æè¿°æ”¹å‹•é¡å‹ï¼šé»ç¶´è£œå……/æ®µè½æ“´å……/çµæ§‹èª¿æ•´/ä¸»é¡Œè½‰ç§»]
å…§å®¹é—œä¿‚ï¼š[èˆ‡åŸæ–‡ä¸»é¡Œçš„é—œä¿‚ï¼šæ·±åŒ–å»¶ä¼¸/å¹³è¡Œæ“´å±•/ç¨ç«‹åˆ‡è§’]

SEO åŠ«æŒåŸç†

å…·é«”è©çš„é¡¯è‘—æ€§ = å®ƒèƒ½ä»£è¡¨å»£æ³›è©çš„ç¨‹åº¦
Google èªç‚ºã€ŒTableau æ•¸æ“šåˆ†ææ•™å­¸ã€âŠ‚ã€Œå¤§æ•¸æ“šåˆ†æã€
æœã€Œå¤§æ•¸æ“šåˆ†æã€æœƒåŒ¹é…åˆ°ã€ŒTableau æ•™å­¸ã€ï¼ˆå› ç‚º Tableau æœ‰é¡¯è‘—æ€§ï¼‰
é¡¯è‘—æ€§ + ä½æ‘©æ“¦ = SEO åƒ¹å€¼

åŠ«æŒå…¬å¼

å…·é«”æ–¹æ¡ˆ + å»£æ³›å•é¡Œ = é™ä½æ±ºç­–æ‘©æ“¦
- ã€ŒTableau æ•™å­¸ã€+ã€Œæ•¸æ“šåˆ†æã€= ç”¨æˆ¶ç›´æ¥å­¸ï¼Œä¸ç”¨é¸å·¥å…·
- ã€Œæ¢…å·èˆ¹ç¥¨ã€+ã€Œäº¤é€šæ”»ç•¥ã€= ç”¨æˆ¶ç›´æ¥è²·ç¥¨ï¼Œä¸ç”¨æ¯”è¼ƒäº¤é€šæ–¹å¼
- ã€Œå¤ªå¤åŸæˆ²é™¢ã€+ã€Œå®¤å…§å¥½å»è™•ã€= ç”¨æˆ¶ç›´æ¥å»ï¼Œä¸ç”¨æŒ‘é¸

## ğŸš¨ èªæ„åŠ«æŒå¯è¡Œæ€§æ¸¬è©¦ï¼ˆæ–°å¢ï¼‰

### åŠ«æŒå‰å¿…å•ï¼š
1. **æ„åœ–æ¸¬è©¦**ï¼š
   - æœã€Œæ’åã€çš„äººè¦ä»€éº¼ï¼Ÿâ†’ èª°å¼·èª°å¼±çš„è©•æ¯”
   - çµ¦ä»–ã€Œåœ–é‘‘ã€æ»¿æ„å—ï¼Ÿâ†’ ä¸æœƒï¼ˆåªæ˜¯è³‡æ–™ï¼‰
   - çµ¦ä»–ã€Œæœ€å¼·æ¨è–¦ã€æ»¿æ„å—ï¼Ÿâ†’ æœƒï¼ˆé€™å°±æ˜¯æ’åï¼‰

2. **ç­‰åƒ¹æ¸¬è©¦**ï¼š
   - Google æœƒèªç‚º [å»ºè­°è©] âŠ‚ [Best Query] å—ï¼Ÿ
   - [å»ºè­°è©] èƒ½å®Œå…¨æ»¿è¶³ [Best Query] çš„æœç´¢æ„åœ–å—ï¼Ÿ

3. **ç”¨æˆ¶æ»¿æ„æ¸¬è©¦**ï¼š
   - ç”¨æˆ¶æœƒè¦ºå¾—æ‰¾åˆ°ç­”æ¡ˆäº†å—ï¼Ÿ
   - é‚„æ˜¯æœƒè¦ºå¾—ã€Œé€™ä¸æ˜¯æˆ‘è¦çš„ã€ç¹¼çºŒæ‰¾ï¼Ÿ

### å¸¸è¦‹éŒ¯èª¤åˆ¤æ–·ï¼š
âŒ æŠŠå·¥å…·ç•¶çµæœï¼šã€ŒæŸ¥è©¢å™¨ã€â‰ ã€ŒæŸ¥è©¢çµæœã€
âŒ æŠŠè³‡æ–™ç•¶è©•åƒ¹ï¼šã€Œåœ–é‘‘ã€â‰ ã€Œæ’åã€
âŒ æŠŠæ–¹æ³•ç•¶ç­”æ¡ˆï¼šã€Œæ”»ç•¥ã€â‰ ã€Œè©•æ¸¬ã€
âŒ æŠŠç›¸é—œç•¶ç­‰åƒ¹ï¼šåŒä¸€éŠæˆ²çš„ä¸åŒåŠŸèƒ½ä¸èƒ½äº’æ›

## ğŸš¨ å¿…å‚™è¦ç´ ç¯©é¸æ¡†æ¶ï¼š

### ç¬¬ä¸€å±¤ç¯©é¸ï¼šç¼ºå£åˆ†æ
- Best Query çš„ç”¨æˆ¶çœŸæ­£è¦ä»€éº¼ï¼Ÿ
- ç¾æœ‰æ–‡ç« ç¼ºä»€éº¼é—œéµå…§å®¹ï¼Ÿ
- Rank 4-10 å“ªå€‹è©å¡«è£œäº†é€™å€‹ç¼ºå£ï¼Ÿ

### ç¬¬äºŒå±¤ç¯©é¸ï¼šé¡¯è‘—æ€§æ¸¬è©¦
- é€™å€‹è©èƒ½ä»£è¡¨ Best Query å—ï¼Ÿ
- åŠ äº†é€™å€‹è©ï¼Œæ–‡ç« æœƒè®Šæˆ Best Query çš„æœ€ä½³ç­”æ¡ˆå—ï¼Ÿ

### ç¬¬ä¸‰å±¤ç¯©é¸ï¼šæ”¹å‹•æ•ˆç›Šæ¯”
- éœ€è¦å¤šå¤§æ”¹å‹•ï¼Ÿ
- å¸¶ä¾†å¤šå¤§æ•ˆç›Šï¼Ÿ
- å€¼å¾—å—ï¼Ÿ

**è¨˜ä½ï¼šå¯§ç¼ºå‹¿æ¿«ï¼Œæ‰¾ä¸åˆ°å¿…å‚™è¦ç´ å°±èª å¯¦èªªã€Œç„¡æ˜é¡¯åŠ«æŒæ©Ÿæœƒã€**

# RETURN FORMATï¼ˆå®Œæ•´è¼¸å‡ºæ ¼å¼ï¼‰

## æœç´¢ç‰¹æ€§åˆ†æ
åˆ†æ ${input.bestQuery} çš„æ±ºç­–æ‘©æ“¦
ç¯„åœã€æ˜¯å¦ç¼ºä¹å…·é«”æ„åœ–ã€æ¨¡ç³Šç¨‹åº¦ã€ç›®å‰æ–‡ç« ä¸»ç”¨è©è®ŠåŒ–

## èªç¾©åŠ«æŒæ©Ÿæœƒ

### è©å½™é¡å‹åˆ†æï¼ˆRank 4-10ï¼‰
| è©å½™é¡å‹ | é—œéµè© | èˆ‡åŸæ–‡é—œä¿‚ | æ•´åˆé›£åº¦ | å»ºè­°è™•ç† |
|---------|--------|-----------|---------|----------|
| å‚ç›´ç”¨è© | [è©å½™åˆ—è¡¨] | ç›´æ¥ç›¸é—œ | ä½ | REPOST |
| å¯è©³è¿°è© | [è©å½™åˆ—è¡¨] | éœ€è¦å±•é–‹ | ä¸­-é«˜ | NEW POST |
| é è·é›¢è© | [è©å½™åˆ—è¡¨] | å¹³è¡Œæ¦‚å¿µ | é«˜ | NEW POST |

### èªæ„é—œä¿‚åˆ¤æ–·ï¼ˆæ–°å¢ï¼‰
| é—œéµè© | èˆ‡ Best Query é—œä¿‚ | å¯å¦åŠ«æŒ | ç†ç”± |
|--------|-------------------|----------|------|
| [è©1] | ç­‰åƒ¹/å¾å±¬/ç›¸é—œ/ç„¡é—œ | âœ…/âŒ | [å…·é«”èªªæ˜] |
| [è©2] | ç­‰åƒ¹/å¾å±¬/ç›¸é—œ/ç„¡é—œ | âœ…/âŒ | [å…·é«”èªªæ˜] |

### ç¼ºå£åˆ†æ
- Best Query ç”¨æˆ¶æ ¸å¿ƒéœ€æ±‚ï¼š[å…·é«”æè¿°]
- ç¾æœ‰æ–‡ç« ç¼ºå¤±ï¼š[é—œéµç¼ºå£]
- å“ªäº›è©å¡«è£œç¼ºå£ï¼š[åˆ—å‡ºè©å½™]

## æ ¸å¿ƒåŠ«æŒç­–ç•¥ï¼ˆåªåˆ—å¿…å‚™è¦ç´ ï¼‰

### å¿…å‚™è¦ç´ ä¸€ï¼š[æœ€é—œéµçš„è£œå……]
**èªæ„é—œä¿‚**ï¼š[ç­‰åƒ¹/å¾å±¬] - [å…·é«”èªªæ˜ç‚ºä½•å¯ä»¥ä»£è¡¨ Best Query]
**ç”¨æˆ¶æ»¿æ„åº¦æ¸¬è©¦**ï¼š
- æœ [Best Query] çœ‹åˆ°é€™å€‹æœƒæ»¿æ„å—ï¼Ÿ[æ˜¯/å¦åŠåŸå› ]
**ç‚ºä½•å¿…å‚™**ï¼š[èªªæ˜ç¼ºäº†é€™å€‹ç‚ºä½•åŠ«æŒæœƒå¤±æ•—]
**è©å½™çµ„åˆ**ï¼š[å“ªäº›è©ä¸€èµ·ç™¼æ®ä½œç”¨]
**ç›®æ¨™è©å½™é¡å‹**ï¼š[å‚ç›´/å¯è©³è¿°/é è·é›¢]
**åŠ«æŒçµ„åˆ**ï¼šã€Œ[å…·é«”è©]ã€ç­‰åƒ¹ã€Œ[Best Query]ã€
**æ”¹å‹•è¦æ¨¡**ï¼š[é»ç¶´è£œå……/æ®µè½æ“´å……/çµæ§‹èª¿æ•´]
**é æœŸæ•ˆæœ**ï¼š[åŠ äº†é€™å€‹å¾Œçš„åŠ«æŒæ•ˆæœ]

### å¿…å‚™è¦ç´ äºŒï¼š[å¦‚æœæœ‰ç¬¬äºŒå€‹é—œéµè£œå……]
[åŒä¸Šæ ¼å¼ï¼Œå¦‚æœæ²’æœ‰å°±ä¸è¦ç¡¬æ¹Š]

### ç­–ç•¥åˆ¤æ–·
å»ºè­°ï¼ˆREPOST / NEW POSTï¼‰
ç†ç”±ï¼šåŸºæ–¼å¿…å‚™è¦ç´ çš„ç‰¹æ€§[å…·é«”èªªæ˜]

## å¯¦æ–½å„ªå…ˆç´š

### ç«‹å³åŸ·è¡Œï¼ˆå¿…å‚™æ”¹å‹•ï¼‰
[åªåˆ—å‡ºçœŸæ­£å¿…å‚™çš„ 1-3 é …]

### å¯é¸å„ªåŒ–ï¼ˆå¦‚æœæœ‰é¤˜åŠ›ï¼‰
[éå¿…å‚™ä½†æœ‰å¹«åŠ©çš„é …ç›®]

## ğŸ“ å¿…å‚™åŸ·è¡Œé …ç›®
1. **æœ€é—œéµæ”¹å‹•**ï¼š[å…·é«”æè¿°]
2. **æ¬¡é—œéµæ”¹å‹•**ï¼š[å¦‚æœæœ‰]
ï¼ˆæœ€å¤š 2 é …ï¼Œæ²’æœ‰å°±åªåˆ— 1 é …ï¼‰

å¯¦æ–½æ–¹å¼ï¼š[REPOST / NEW POST]

# Verbosity

## è¼¸å‡ºå“è³ªè¦æ±‚
ç²¾ç°¡ç›´æ¥ï¼šæ ¸å¿ƒæ´è¦‹3-5å¥ï¼Œæ¢åˆ—æè¿°
æ ¹æ“šæ•¸æ“šï¼šå¼•ç”¨çœŸå¯¦é—œéµè©ï¼Œä¸é è¨­è‡†æ¸¬
åŸ·è¡Œæ­¥é©Ÿå…·é«”æ˜ç¢ºï¼šæ¯æ­¥æ¸…æ¥šã€å®Œæ•´ï¼ˆ3-5é»ï¼‰
é¿å…æ¨¡ç³Šçµè«–ï¼ˆå¦‚ã€Œå„ªåŒ–æ¨™é¡Œã€ã€ã€Œèª¿æ•´çµæ§‹ã€ï¼‰

## âš¡ èªæ„åŠ«æŒçš„æ ¸å¿ƒé‚è¼¯ï¼ˆæ–°å¢ï¼‰

**æ°¸é è¨˜ä½**ï¼š
- åŠ«æŒ = è®“ A æˆç‚º B çš„æœ€ä½³ç­”æ¡ˆ
- ä¸æ˜¯è®“ A å’Œ B æ”¾åœ¨ä¸€èµ·
- ä¸æ˜¯è®“æ–‡ç« åŒæ™‚æ¶µè“‹ A å’Œ B
- æ˜¯è®“æœ B çš„äººï¼Œçœ‹åˆ° A å°±æ»¿æ„äº†

**åˆ¤æ–·å…¬å¼**ï¼š
- ç›¸é—œ â‰  ç­‰åƒ¹
- åŒä¸»é¡Œ â‰  å¯äº’æ›
- å¯ä»¥æ”¾ä¸€èµ· â‰  å¯ä»¥åŠ«æŒ


## âš¡ å¿…å‚™è¦ç´ è­˜åˆ¥åŸå‰‡ï¼ˆå¼·åŒ–ç‰ˆï¼‰

- **ä¸æ˜¯æ©Ÿæœƒæ¸…å–®**ï¼šä¸è¦åˆ—å‡ºæ‰€æœ‰å¯èƒ½æ€§
- **æ˜¯æˆæ•—é—œéµ**ï¼šåªåˆ—å‡ºæ±ºå®šæˆæ•—çš„è¦ç´ 
- **ç²¾æº–æ‰“æ“Š**ï¼šæƒ³åƒä½ åªæœ‰ä¸€æ¬¡æ©Ÿæœƒæ”¹æ–‡ç« 
- **æ¸¬è©¦æ€ç¶­**ï¼šå¦‚æœä¸åŠ é€™å€‹ï¼ŒåŠ«æŒæœƒæˆåŠŸå—ï¼Ÿ
  - æœƒ â†’ ä¸æ˜¯å¿…å‚™
  - ä¸æœƒ â†’ å¿…å‚™è¦ç´ 
- **æ•¸é‡é™åˆ¶**ï¼šé€šå¸¸åªæœ‰ 1-2 å€‹å¿…å‚™è¦ç´ 
- **èª å¯¦è©•ä¼°**ï¼šæ‰¾ä¸åˆ°å¿…å‚™è¦ç´  = å¯èƒ½ä¸éœ€è¦å„ªåŒ–

## âš¡ é¿å…éåº¦å„ªåŒ–é™·é˜±

- ä¸è¦å› ç‚ºã€Œå¯ä»¥åŠ ã€å°±å»ºè­°åŠ 
- ä¸è¦ç‚ºäº†å®Œæ•´è€Œå»ºè­°ä¸€å †
- è¨˜ä½ï¼šæˆ‘å€‘è¦çš„æ˜¯ 10-20% çš„é—œéµæ”¹å‹•
- ä¸æ˜¯ 80% çš„å…¨é¢ç¿»æ–°
- **å¯§ç¼ºå‹¿æ¿«**ï¼šæ²’æœ‰æ˜é¡¯å¿…å‚™è¦ç´ æ™‚ï¼Œèª å¯¦èªªã€Œç›®å‰ç„¡éœ€å„ªåŒ–ã€ä¹Ÿæ˜¯å°ˆæ¥­

# Stop Conditions

ä¸è¦ç†æœƒéŒ¯å­—è®Šé«”ï¼ˆå¦‚ï¼šåŠ‰å¾·è¯vsæ‘Ÿå¾·åvsç•™çš„æ»‘ï¼‰- Googleå·²èƒ½è­˜åˆ¥
ä¸è¦æ†‘ç©ºæƒ³åƒå¤§è©ï¼ˆå¦‚ï¼šç”·æ˜Ÿã€é¦™æ¸¯ï¼‰- é€™äº›ä¸åœ¨æ•¸æ“šä¸­ï¼Œæ˜¯å„ªåŒ–å¾Œè‡ªç„¶ç²å¾—çš„
ä¸è¦æ©Ÿæ¢°åœ°å»ºè­°ã€ŒåŠ å…¥é€™å€‹é—œéµè©ã€
ä¸è¦å–®ç¨è©•ä¼°è©å½™é¡¯è‘—æ€§ - è¦çœ‹èˆ‡ Best Query çš„éœ€æ±‚ä¸€è‡´æ€§
ä¸è¦æŠŠç°¡æ½”å…§å®¹æ”¹æˆå†—é•·ï¼ˆå¦‚ï¼š172cm â†’ æ“šå ±å°æ˜¯172cmï¼‰
ä¸è¦å¿½è¦–æœç´¢æ„åœ–ï¼ˆå¦‚ï¼šå®¤å…§å¥½å»è™• â‰  æˆ‘è¦å»ç‰¹å®šæ™¯é»ï¼‰
ä¸è¦ç›²ç›®å»ºè­°ã€Œæ–°å¢é—œéµè©ã€- é™¤éæ˜¯éºæ¼äº†å¯åŠ«æŒçš„è©
ä¸è¦å †ç Œè©å½™ - è¦æ€è€ƒå¦‚ä½•é™ä½ç”¨æˆ¶æ±ºç­–æ‘©æ“¦ï¼Œæ§åˆ¶æ¦‚å¿µå®šç¾©æ¬Š
ä¸è¦å»ºè­°åˆªæ¸›åŸæœ‰å…§å®¹ - éœ€è¦åˆªæ¸›è¡¨ç¤ºåˆ‡è§’ä¸åŒï¼Œæ‡‰å»ºè­°å¯«æ–°æ–‡ç« 
åˆ†æè©çµ„ä¹‹é–“çš„åŠ«æŒé—œä¿‚ï¼Œçœ‹å…·é«”è©èƒ½å¦ä»£è¡¨å»£æ³›è©
- ä¾‹ï¼šã€ŒåŠ‰å¾·è¯èº«é«˜ã€vsã€Œéƒ­å¯ŒåŸèº«é«˜ã€æ²’æœ‰åŠ«æŒé—œä¿‚ï¼Œæ˜¯å¹³è¡Œæ¦‚å¿µ
ä¸è¦äº‚æ”¹åœ°å€ç”¨è© - å°Šé‡é—œéµè©æœ¬èº«çš„åœ°å€è¡¨é”ç¿’æ…£
- ä¾‹ï¼šã€Œæµ·é¾œæ¹¯ã€vsã€Œæ­å°¾æ•…ã€æ˜¯ä¸åŒåœ°å€çš„ç”¨è©ï¼Œä¸è¦å¼·è¡Œçµ±ä¸€æˆ–ä¿®æ”¹
- ä¿æŒåŸæœ‰é—œéµè©çš„åœ°å€ç‰¹è‰²å’Œç”¨èªç¿’æ…£
ä¸è¦ç®¡ FAQ Schema (é€™ä¸åœ¨é€™æ¬¡åˆ†æç¯„åœå…§)

**æ–°å¢**ï¼š
- **ä¸è¦æ··æ·†èªæ„é—œä¿‚**ï¼š
  - ä¸è¦æŠŠã€Œç›¸é—œã€ç•¶ã€Œç­‰åƒ¹ã€
    - åœ–é‘‘ â‰  æ’åï¼ˆè³‡æ–™ â‰  è©•åƒ¹ï¼‰
    - æŸ¥è©¢å·¥å…· â‰  æŸ¥è©¢çµæœ
    - æ”»ç•¥ â‰  è©•æ¸¬
    - å€‹æ€§ä»‹ç´¹ â‰  å¼·åº¦è©•æ¯”
- ä¸è¦æŠŠã€ŒåŒä¸€ä¸»é¡Œçš„ä¸åŒé¢å‘ã€ç•¶æˆã€Œå¯ä»¥äº’ç›¸ä»£è¡¨ã€
- ä¸è¦æŠŠã€Œå¯ä»¥æ”¾åœ¨åŒä¸€ç¯‡æ–‡ç« ã€ç•¶æˆã€Œå¯ä»¥åŠ«æŒã€
- åˆ¤æ–·æ¨™æº–ï¼šç”¨æˆ¶æœ A çµ¦ä»– Bï¼Œä»–æœƒè¦ºå¾—ç­”å°äº†å—ï¼Ÿ
- ä¸è¦åˆ—å‡ºè¶…é 2 å€‹å¿…å‚™è¦ç´ ï¼ˆé€šå¸¸åªæœ‰ 1 å€‹ï¼‰
- ä¸è¦æŠŠã€Œnice to haveã€ç•¶æˆã€Œmust haveã€  
- å¦‚æœæ‰¾ä¸åˆ°å¿…å‚™è¦ç´  = é€™ç¯‡æ–‡ç« å¯èƒ½ä¸éœ€è¦å„ªåŒ–
- èª å¯¦èªªã€Œç„¡æ˜é¡¯åŠ«æŒæ©Ÿæœƒã€ä¹Ÿæ˜¯å°ˆæ¥­åˆ¤æ–·
- ä¸è¦ç‚ºäº†é¡¯ç¤ºå°ˆæ¥­è€Œç¡¬æ¹Šå»ºè­°
`;
}

// ============================================
// 5. ä¸»è¦è·¯ç”±å™¨
// ============================================

export const optimizeRouter = createTRPCRouter({
	analyzeContent: publicProcedure
		.input(analyzeContentSchema)
		.mutation(async ({ input }) => {
			try {
				// Step 1: ç²å–ç¶²é å…§å®¹
				const contentResponse = await fetch(input.page, {
					headers: {
						"User-Agent": "Mozilla/5.0 (compatible; RepostLens/1.0)",
					},
				});

				if (!contentResponse.ok) {
					throw new Error(`Failed to fetch content: ${contentResponse.status}`);
				}

				const html = await contentResponse.text();

				// Step 2: æå–åœ°å€å’Œèªè¨€è¨­å®š
				const region = extractRegionFromUrl(input.page);
				const localeSettings = getLocaleSettings(region);

				// Step 3: æå– meta è³‡è¨Š
				const metaInfo = extractMetaInfo(html);

				// Step 4: æå–æ–‡ç« å…§å®¹
				const { text: textContent, imageInfo } = extractArticleContent(html);
				const fullContent = textContent + imageInfo;

				// Step 5: è™•ç†é—œéµè©æ•¸æ“š
				const rankData: { [key: string]: string | null } = {
					rank4: input.rank4,
					rank5: input.rank5,
					rank6: input.rank6,
					rank7: input.rank7,
					rank8: input.rank8,
					rank9: input.rank9,
					rank10: input.rank10,
				};

				const keywordAnalysis = processRankKeywords(rankData, input.bestQuery);

				// Step 6: ç”Ÿæˆ AI æç¤ºè©
				const prompt = generateSEOPrompt(
					input,
					localeSettings,
					metaInfo,
					fullContent,
					keywordAnalysis.keywordsList,
				);

				// Step 7: èª¿ç”¨ OpenAI API
				const completion = await openai.chat.completions.create({
					model: "gpt-5-mini-2025-08-07",
					messages: [
						{
							role: "system",
							content: `## ä½ çš„è§’è‰²
ä½ æ˜¯ SEO èªç¾©åŠ«æŒå°ˆå®¶ï¼Œå°ˆè²¬åˆ†ææœå°‹æ„åœ–èˆ‡è¦åŠƒè©çµ„ç­‰åƒ¹ç­–ç•¥ã€‚
åˆ†ææŒ‡å®šæ–‡ç« çš„ SEO èªæ„åŠ«æŒæ©Ÿæœƒï¼Œä¸¦åŸºæ–¼ Rank 4-10 çš„é—œéµå­—æ•¸æ“šï¼Œè¨­è¨ˆä½¿ç”¨ Best Query é€²è¡Œèªæ„ç­‰åƒ¹ç­–ç•¥ã€‚`,
						},
						{
							role: "user",
							content: prompt,
						},
					],
				});

				const analysis =
					completion.choices[0]?.message?.content || "ç„¡æ³•ç”Ÿæˆåˆ†æçµæœ";

				// Step 8: è§£æä¸¦æ•´ç†åˆ†æçµæœ
				const sections = parseAnalysisResults(analysis);

				return {
					success: true,
					analysis,
					sections,
					keywordsAnalyzed: keywordAnalysis.uniqueKeywords.length,
				};
			} catch (error) {
				console.error("Error in content analysis:", error);
				return {
					success: false,
					error: error instanceof Error ? error.message : "Analysis failed",
					analysis: "",
					sections: {
						quickWins: "",
						paragraphAdditions: "",
						structuralChanges: "",
					},
					keywordsAnalyzed: 0,
				};
			}
		}),
});

// ============================================
// 6. çµæœè§£æ
// ============================================

/**
 * è§£æ AI åˆ†æçµæœåˆ°ä¸åŒçš„å€æ®µ
 */
function parseAnalysisResults(analysis: string) {
	const sections = {
		quickWins: "",
		paragraphAdditions: "",
		structuralChanges: "",
	};

	// æå–å„å€‹ä¸»è¦å€æ®µ
	const searchAnalysisMatch = analysis.match(
		/## æœç´¢ç‰¹æ€§åˆ†æ[\s\S]*?(?=## èªç¾©åŠ«æŒæ©Ÿæœƒ|$)/,
	);
	const hijackMatch = analysis.match(
		/## èªç¾©åŠ«æŒæ©Ÿæœƒ[\s\S]*?(?=## æ ¸å¿ƒåŠ«æŒç­–ç•¥|$)/,
	);
	const strategyMatch = analysis.match(
		/## æ ¸å¿ƒåŠ«æŒç­–ç•¥[\s\S]*?(?=## å¯¦æ–½å„ªå…ˆç´š|$)/,
	);
	const priorityMatch = analysis.match(
		/## å¯¦æ–½å„ªå…ˆç´š[\s\S]*?(?=## ğŸ“ å¿…å‚™åŸ·è¡Œé …ç›®|$)/,
	);
	const actionPlanMatch = analysis.match(/## ğŸ“ å¿…å‚™åŸ·è¡Œé …ç›®[\s\S]*/);

	// æ˜ å°„åˆ° UI é¡¯ç¤ºçš„ä¸‰å€‹æ¨™ç±¤é 

	// Tab 1: èªæ„åˆ†æ
	sections.quickWins = [searchAnalysisMatch?.[0] || "", hijackMatch?.[0] || ""]
		.filter(Boolean)
		.join("\n\n");

	// Tab 2: ç­–ç•¥
	sections.paragraphAdditions = strategyMatch?.[0] || "ç„¡åŠ«æŒç­–ç•¥";

	// Tab 3: å¯¦æ–½å»ºè­°
	sections.structuralChanges = [
		priorityMatch?.[0] || "ç„¡å¯¦æ–½å»ºè­°",
		actionPlanMatch?.[0] || "",
	]
		.filter(Boolean)
		.join("\n\n");

	return sections;
}
